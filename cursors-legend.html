<!DOCTYPE html>
<html lang="en">

<head>
    <title>Flot Examples: Cursors and Cursor Legend</title>
    <link rel="stylesheet" href="jqwidgets/jqx.base.css" type="text/css" />
    <link href="example.css" rel="stylesheet" type="text/css">

    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="jqwidgets/jqxcore.js"></script>
    <script type="text/javascript" src="jqwidgets/jqxdata.js"></script>
    <script type="text/javascript" src="jqwidgets/jqxbuttons.js"></script>
    <script type="text/javascript" src="jqwidgets/jqxcheckbox.js"></script>
    <script type="text/javascript" src="jqwidgets/jqxscrollbar.js"></script>
    <script type="text/javascript" src="jqwidgets/jqxmenu.js"></script>
    <script type="text/javascript" src="jqwidgets/jqxgrid.js"></script>
    <script type="text/javascript" src="jqwidgets/jqxgrid.selection.js"></script>
    <script type="text/javascript" src="jqwidgets/jqxnumberinput.js"></script>
    <script type="text/javascript" src="jqwidgets/jqxwindow.js"></script>
    <script type="text/javascript" src="jqwidgets/jqxcolorpicker.js"></script>
    <script type="text/javascript" src="jqwidgets/jqxdropdownbutton.js"></script>
    <script type="text/javascript" src="jqwidgets/jqxlistbox.js"></script>
    <script type="text/javascript" src="jqwidgets/jqxdropdownlist.js"></script>

    <script language="javascript" type="text/javascript" src="jquery.flot.js"></script>
    <script language="javascript" type="text/javascript" src="jquery.flot.symbol.js"></script>
    <script language="javascript" type="text/javascript" src="jquery.flot.cursors.js"></script>
    <script type="text/javascript" type="text/javascript" src="cursors-legend.js"></script>

    <script type="text/javascript">
        var initLegend = function () {
            var cursorCounter = 1;
            var cursorColors = ['#FF0000', '#000080', '#FF00FF', '#4B0082', '#DAA520', '#FFC0CB', '#FA8072']

            var plot = window.myPlot;
            // prepare the data

            var data = [];

            plot.getCursors().forEach(function (cursor) {
                data.push({
                    cursorname: cursor.name,
                    x: 0,
                    y: 0,
                });
            });

            var cursorModes = [
                "xy",
                "x",
                "y",
            ];

            var shapes = [
                'square',
                'diamond',
                'triangle',
                'cross'
            ];

            var snapTo = [
                'none',
                'plot 1',
                'plot 2'
            ];


            function getTextElementByColor(color) {
                if (color == 'transparent' || color.hex == "") {
                    return $("<div style='text-shadow: none; position: relative; margin: 2px; height: 26px;'><span style='top: 2px; position: relative; font-size: 16px;'>transparent</span></div>");
                }
                var element = $("<div style='text-shadow: none; height: 26px; margin: 2px; position: relative;'><span style='top: 2px; position: relative; font-size: 16px;'>#" + color.hex + "</span></div>");
                var nThreshold = 105;
                var bgDelta = (color.r * 0.299) + (color.g * 0.587) + (color.b * 0.114);
                var foreColor = (255 - bgDelta < nThreshold) ? 'Black' : 'White';
                element.css('color', foreColor);
                element.css('background', "#" + color.hex);
                element.addClass('jqx-rc-all');
                return element;
            }

            var source = {
                localdata: data,
                datatype: "array",
                datafields: [
                    {
                        name: 'cursorname',
                        type: 'string'
                    },
                    {
                        name: 'x',
                        type: 'number'
                    },
                    {
                        name: 'y',
                        type: 'number'
                    }
                        ],
                updaterow: function (rowid, rowdata, commit) {
                    // synchronize with the server - send update command
                    // call commit with parameter true if the synchronization with the server is successful 
                    // and with parameter false if the synchronization failed.
                    commit(true);
                },
                deleterow: function (rowid, commit) {
                    // synchronize with the server - send delete command
                    // call commit with parameter true if the synchronization with the server is successful 
                    // and with parameter false if the synchronization failed.
                    commit(true);
                },
                addrow: function (rowid, rowdata, position, commit) {
                    // synchronize with the server - send delete command
                    // call commit with parameter true if the synchronization with the server is successful 
                    // and with parameter false if the synchronization failed.
                    commit(true);
                }
            };

            // initialize the input fields.
            $("#cursorname").addClass('jqx-input');
            $("#cursorname").width(200);
            $("#cursorname").height(23);

            var dataAdapter = new $.jqx.dataAdapter(source);
            var editrow = -1;

            // initialize jqxGrid
            $("#jqxgrid").jqxGrid({
                width: 400,
                height: 120,
                source: dataAdapter,
                autoheight: false,
                columns: [
                    {
                        text: 'Cursor Name',
                        datafield: 'cursorname',
                        width: 200
                    },
                    {
                        text: 'X',
                        datafield: 'x',
                        width: 100,
                        cellsalign: 'left',
                        cellsformat: 'f4'
                    },
                    {
                        text: 'Y',
                        datafield: 'y',
                        cellsalign: 'left',
                        cellsformat: 'f4'
                    }
                ]
            });

            // create context menu
            var contextMenu = $("#Menu").jqxMenu({
                width: 200,
                height: 81,
                autoOpenPopup: false,
                mode: 'popup'
            });

            $("#jqxgrid").on('contextmenu', function () {
                return false;
            });

            // handle context menu clicks.
            $("#Menu").on('itemclick', function (event) {
                var args = event.args;
                var rowindex = $("#jqxgrid").jqxGrid('getselectedrowindex');
                if ($.trim($(args).text()) == "Edit Selected Cursor") {
                    editrow = rowindex;
                    var offset = $("#jqxgrid").offset();
                    $("#popupWindow").jqxWindow({
                        position: {
                            x: parseInt(offset.left) + 60,
                            y: parseInt(offset.top) + 60
                        }
                    });

                    // get the clicked row's data and initialize the input fields.
                    var dataRecord = $("#jqxgrid").jqxGrid('getrowdata', editrow);

                    var cursorData = plot.getCursors()[editrow]
                    $("#cursorname").val(dataRecord.cursorname);
                    $("#dropDownButton").jqxDropDownButton('setContent', getTextElementByColor(new $.jqx.color({
                        hex: cursorData.color.substring(1)
                    })));

                    $("#jqxdropdownlist").jqxDropDownList('selectItem', cursorData.mode);
                    $("#jqxshapedropdownlist").jqxDropDownList('selectItem', cursorData.symbol);
                    $("#jqxsnapdropdownlist").jqxDropDownList('selectItem', (cursorData.snapToPlot !== undefined) ? 'plot ' + (cursorData.snapToPlot + 1) : 'none');
                    $('#jqxcheckbox1').val(cursorData.showLabel);
                    $('#jqxcheckbox2').val(cursorData.showIntersections);

                    // show the popup window.
                    $("#popupWindow").jqxWindow('show');
                } else if ($.trim($(args).text()) == "Add Cursor") {
                    var x = 33 + cursorCounter * 10;
                    var y = 44 + cursorCounter * 10;
                    var name = 'Cursor ' + cursorCounter;
                    plot.addCursor({
                        name: name,
                        position: {
                            relativeX: x,
                            relativeY: y
                        },
                        showLabel: true,
                        color: cursorColors[cursorCounter]
                    });
                    $("#jqxgrid").jqxGrid('addrow', null, {
                        cursorname: name,
                        x: x,
                        y: y,
                    });

                    cursorCounter++;
                } else {
                    var rowid = $("#jqxgrid").jqxGrid('getrowid', rowindex);
                    $("#jqxgrid").jqxGrid('deleterow', rowid);
                    plot.removeCursor(plot.getCursors()[rowid]);
                }
            });

            $("#jqxgrid").on('rowclick', function (event) {
                if (event.args.rightclick) {
                    $("#jqxgrid").jqxGrid('selectrow', event.args.rowindex);
                    var scrollTop = $(window).scrollTop();
                    var scrollLeft = $(window).scrollLeft();
                    contextMenu.jqxMenu('open', parseInt(event.args.originalEvent.clientX) + 5 + scrollLeft, parseInt(event.args.originalEvent.clientY) + 5 + scrollTop);

                    return false;
                }
            });

            // initialize the popup window and buttons.
            $("#popupWindow").jqxWindow({
                width: 300,
                height: 300,
                resizable: false,
                isModal: true,
                autoOpen: false,
                cancelButton: $("#Cancel"),
                modalOpacity: 0.01
            });
            $("#Cancel").jqxButton({});
            $("#Apply").jqxButton({});
            $("#jqxcheckbox1").jqxCheckBox({
                //width: 120,
                height: 25
            });
            $("#jqxcheckbox2").jqxCheckBox({
                //width: 120,
                height: 25
            });

            $("#colorPicker").on('colorchange', function (event) {
                $("#dropDownButton").jqxDropDownButton('setContent', getTextElementByColor(event.args.color));
            });

            $("#dropDownButton").jqxDropDownButton({
                animationType: 'none',
                width: '100%',
                dropDownHeight: 250,
                height: 30
            });

            $("#colorPicker").jqxColorPicker({
                color: "ffaabb",
                colorMode: 'hue',
                width: '100%',
                height: 242
            });

            $("#dropDownButton").jqxDropDownButton('setContent', getTextElementByColor(new $.jqx.color({
                hex: "ffaabb"
            })));

            $("#jqxdropdownlist").jqxDropDownList({
                source: cursorModes,
                selectedIndex: 0,
                width: '200px',
                height: '25px'
            });

            $("#jqxshapedropdownlist").jqxDropDownList({
                source: shapes,
                selectedIndex: 0,
                width: '200px',
                height: '25px'
            });

            $("#jqxsnapdropdownlist").jqxDropDownList({
                source: snapTo,
                selectedIndex: 0,
                width: '200px',
                height: '25px'
            });

            // update the edited row when the user clicks the 'Save' button.
            $("#Apply").click(function () {
                var row = $("#jqxgrid").jqxGrid('getrowdata', editrow);
                row.cursorname = $("#cursorname").val();
                var mode = $('#jqxdropdownlist').val();
                var shape = $('#jqxshapedropdownlist').val();
                var color = $('#dropDownButton').val();
                var rowid = $("#jqxgrid").jqxGrid('getrowid', editrow);
                var snapToId = $("#jqxsnapdropdownlist").jqxDropDownList('getSelectedItem').index;
                var showLabel = $('#jqxcheckbox1').val();
                var showIntersections = $('#jqxcheckbox2').val();

                $('#jqxgrid').jqxGrid('updaterow', rowid, row);

                plot.setCursor(plot.getCursors()[rowid], {
                    name: row.cursorname,
                    mode: mode,
                    color: color,
                    showLabel: showLabel,
                    showIntersections: showIntersections,
                    symbol: shape,
                    snapToPlot: [undefined, 0, 1][snapToId]
                });

                $("#popupWindow").jqxWindow('hide');
            });

            $("#placeholder").bind("cursorupdates", function (event, cursordata) {
                var i = 0;
                cursordata.forEach(function (cursor) {
                    var row = $("#jqxgrid").jqxGrid('getrowdata', i);
                    if (row) {
                        row.x = cursor.x;
                        row.y = cursor.y;
                        $('#jqxgrid').jqxGrid('updaterow', i, row);
                    }
                    i++;
                });
            });
        };

        $(document).ready(initLegend);
    </script>
</head>

<body class='default'>
    <div id="header">
        <h2>Flot cursors and cursor legend</h2>
    </div>
    <div id="content">
        <div class="demo-container">
            <div id="placeholder" class="demo-placeholder"></div>
        </div>
        <div id='jqxWidget' style="margin-left: 15px;">
            <div id="jqxgrid"></div>
            <div style="margin-top: 10px;">
                <div id="cellbegineditevent"></div>
                <div style="margin-top: 10px;" id="cellendeditevent"></div>
            </div>
            <div id="popupWindow">
                <div>Edit cursor</div>
                <div style="overflow: hidden;">
                    <table>
                        <tr>
                            <td align="right">Name</td>
                            <td align="left">
                                <input id="cursorname" />
                            </td>
                        </tr>
                        <tr>
                            <td align="right">
                                Color
                            </td>
                            <td align="left">
                                <div id="dropDownButton">
                                    <div id="colorPicker">
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td align="right">
                                Mode
                            </td>
                            <td align="left">
                                <div id='jqxdropdownlist'>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td align="right">
                                Shape
                            </td>
                            <td align="left">
                                <div id='jqxshapedropdownlist'>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td align="right">
                                Snap To
                            </td>
                            <td align="left">
                                <div id='jqxsnapdropdownlist'>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td align="right">
                            </td>
                            <td align="left">
                                <div id='jqxcheckbox1'>Show Label</div>
                                <div id='jqxcheckbox2'>Show Intersections</div>
                            </td>
                        </tr>
                        <tr>
                            <td align="right"></td>
                            <td style="padding-top: 10px;" align="right">
                                <input style="margin-right: 5px;" type="button" id="Apply" value="Apply" />
                                <input id="Cancel" type="button" value="Cancel" />
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <div id='Menu'>
                <ul>
                    <li>Edit Selected Cursor</li>
                    <li>Delete Selected Cursor</li>
                    <li>Add Cursor</li>
                </ul>
            </div>
        </div>
        <p>
            <input id="checkbox" type="checkbox" name="Dynamic data" value="0" checked>Dynamic chart data
        </p>
        <p>This is an example of how you can use jqWidgets to create a cursors legend. Right click on the cursor legend to add, edit delete cursors</p>
    </div>
</body>

</html>
